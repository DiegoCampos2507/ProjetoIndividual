<!DOCTYPE html>
<html lang="PT-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Well Being | Postagens</title>
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="css/stylewellbeing.css" />
  <link rel="shortcut icon" href="assets/images/logoSimples.png" type="image/x-icon" />
</head>

<body onload="acessar()">
  <div class="background">
    <div class="header">
      <div class="container-comunidade">
        <div class="logo">
          <button onclick="sair()">
            <img src="assets/images/logoExtendida.png" alt="Logo extensa" />
          </button>
        </div>
      </div>
    </div>
    <div class="fantasma"></div>
    <div id="titulo" class="titulo-post" style="color: aliceblue">
      <a href="comunidades.html"><- Voltar para comunidades</a>
          <div class="participar">
            <button onclick="participar()" id="btn_participar" class="participar-checkbox"> Participar
            </button>
          </div>
    </div>
    <div class="usuario">
      <textarea id="inp_post" maxlength="1000" type="text" placeholder="Sobre o que você quer falar?..."></textarea>
    </div>
    <div class="envio">
      <button onclick="postar()">Postar</button>
    </div>
    <div class="posts" id="posts"></div>
  </div>
  <div id="mensagem_sair" class="mensagem-sair">
    <button class="fechar" onclick="fechar()">X</button>
    <span>
      Você tem certeza que deseja sair? <br />
      Atenção! Você será deslogado do sistema
    </span>
    <button class="home" onclick="home()">Sair</button>
  </div>
</body>

<script>
  var local = sessionStorage.LOCAL;
  titulo.innerHTML += `<h2>${local}</h2>`;
  var participa1 = sessionStorage.participa1;
  var participa2 = sessionStorage.participa2;
  var participa3 = sessionStorage.participa3;
  var participa4 = sessionStorage.participa4;
  var participa5 = sessionStorage.participa5;
  var participa6 = sessionStorage.participa6;

  if (local == "Ansiedade") {
    sessionStorage.IDGRUPO = 1;
    if (participa1 == 1) {
      btn_participar.innerHTML = "Desinscrever";
      btn_participar.onclick = function deletar() {
        fetch("/user/remover", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            idUsuarioServer: sessionStorage.ID_USUARIO,
            idGrupoServer: sessionStorage.IDGRUPO,
          }),
        })
        .then(function (resposta) {
          console.log("ESTOU NO THEN DO entrar()!");
          
          if (resposta.ok) {
            resposta.json().then(function (resposta) {
              console.log("Dados recebidos: ", JSON.stringify(resposta));
              
              alert("Você não participa mais do grupo: " + local);
              window.location.reload(true);
              sessionStorage.participa1 = 0;
            });
          } else {
            alert("Houve um erro ao tentar realizar o login!");
            console.log("Houve um erro ao tentar realizar o login!");
          }
        })
        .catch(function (erro) {
          console.log(erro);
        });
        sessionStorage.GRUPOS_USUARIO--;
        
        return false;
      };
    } else {
      btn_participar.innerHTML = "Inscrever";
      btn_participar.onclick = function participar() {
        fetch("/user/participar", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            idUsuarioServer: sessionStorage.ID_USUARIO,
            idGrupoServer: sessionStorage.IDGRUPO,
          }),
        })
        .then(function (resposta) {
          console.log("ESTOU NO THEN DO entrar()!");
          
          if (resposta.ok) {
            resposta.json().then(function (resposta) {
              console.log("Dados recebidos: ", JSON.stringify(resposta));
              
              alert("Bem-vindo ao grupo: " + local);
              window.location.reload(true);
              sessionStorage.participa1 = 1;
            });
          } else {
            alert("Houve um erro ao tentar realizar o login!");
            console.log("Houve um erro ao tentar realizar o login!");
          }
        })
        .catch(function (erro) {
          console.log(erro);
        });
        sessionStorage.GRUPOS_USUARIO++;
  
        return false;
      };
    }
  } else if (local == "Depressão") {
    sessionStorage.IDGRUPO = 2;
    if (participa2 == 1) {
      btn_participar.innerHTML = "Desinscrever";
      btn_participar.onclick = function deletar() {
        fetch("/user/remover", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            idUsuarioServer: sessionStorage.ID_USUARIO,
            idGrupoServer: sessionStorage.IDGRUPO,
          }),
        })
        .then(function (resposta) {
          console.log("ESTOU NO THEN DO entrar()!");
          
          if (resposta.ok) {
            resposta.json().then(function (resposta) {
              console.log("Dados recebidos: ", JSON.stringify(resposta));
              
              alert("Você não participa mais do grupo: " + local);
              window.location.reload(true);
              sessionStorage.participa2 = 0;
            });
          } else {
            alert("Houve um erro ao tentar realizar o login!");
            console.log("Houve um erro ao tentar realizar o login!");
          }
        })
        .catch(function (erro) {
          console.log(erro);
        });
        sessionStorage.GRUPOS_USUARIO--;
        
        return false;
      };
    } else {
      btn_participar.innerHTML = "Inscrever";
      btn_participar.onclick = function participar() {
        fetch("/user/participar", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            idUsuarioServer: sessionStorage.ID_USUARIO,
            idGrupoServer: sessionStorage.IDGRUPO,
          }),
        })
        .then(function (resposta) {
          console.log("ESTOU NO THEN DO entrar()!");
          
          if (resposta.ok) {
            resposta.json().then(function (resposta) {
              console.log("Dados recebidos: ", JSON.stringify(resposta));
              
              alert("Bem-vindo ao grupo: " + local);
              window.location.reload(true);
              sessionStorage.participa2 = 1;
            });
          } else {
            alert("Houve um erro ao tentar realizar o login!");
            console.log("Houve um erro ao tentar realizar o login!");
          }
        })
        .catch(function (erro) {
          console.log(erro);
        });
        sessionStorage.GRUPOS_USUARIO++;
  
        return false;
      };
    }
  } else if (local == "TDAH") {
    sessionStorage.IDGRUPO = 3;
    if (participa3 == 1) {
      btn_participar.innerHTML = "Desinscrever";
      btn_participar.onclick = function deletar() {
        fetch("/user/remover", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            idUsuarioServer: sessionStorage.ID_USUARIO,
            idGrupoServer: sessionStorage.IDGRUPO,
          }),
        })
        .then(function (resposta) {
          console.log("ESTOU NO THEN DO entrar()!");
          
          if (resposta.ok) {
            resposta.json().then(function (resposta) {
              console.log("Dados recebidos: ", JSON.stringify(resposta));
              
              alert("Você não participa mais do grupo: " + local);
              window.location.reload(true);
              sessionStorage.participa3 = 0;
            });
          } else {
            alert("Houve um erro ao tentar realizar o login!");
            console.log("Houve um erro ao tentar realizar o login!");
          }
        })
        .catch(function (erro) {
          console.log(erro);
        });
        sessionStorage.GRUPOS_USUARIO--;
        
        return false;
      };
    } else {
      btn_participar.innerHTML = "Inscrever";
      btn_participar.onclick = function participar() {
        fetch("/user/participar", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            idUsuarioServer: sessionStorage.ID_USUARIO,
            idGrupoServer: sessionStorage.IDGRUPO,
          }),
        })
        .then(function (resposta) {
          console.log("ESTOU NO THEN DO entrar()!");
          
          if (resposta.ok) {
            resposta.json().then(function (resposta) {
              console.log("Dados recebidos: ", JSON.stringify(resposta));
              
              alert("Bem-vindo ao grupo: " + local);
              window.location.reload(true);
              sessionStorage.participa3 = 1;
            });
          } else {
            alert("Houve um erro ao tentar realizar o login!");
            console.log("Houve um erro ao tentar realizar o login!");
          }
        })
        .catch(function (erro) {
          console.log(erro);
        });
        sessionStorage.GRUPOS_USUARIO++;
  
        return false;
      };
    }
  } else if (local == "Transtorno Alimentar") {
    sessionStorage.IDGRUPO = 4;
    if (participa4 == 1) {
      btn_participar.innerHTML = "Desinscrever";
      btn_participar.onclick = function deletar() {
        fetch("/user/remover", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            idUsuarioServer: sessionStorage.ID_USUARIO,
            idGrupoServer: sessionStorage.IDGRUPO,
          }),
        })
        .then(function (resposta) {
          console.log("ESTOU NO THEN DO entrar()!");
          
          if (resposta.ok) {
            resposta.json().then(function (resposta) {
              console.log("Dados recebidos: ", JSON.stringify(resposta));
              
              alert("Você não participa mais do grupo: " + local);
              window.location.reload(true);
              sessionStorage.participa4 = 0;
            });
          } else {
            alert("Houve um erro ao tentar realizar o login!");
            console.log("Houve um erro ao tentar realizar o login!");
          }
        })
        .catch(function (erro) {
          console.log(erro);
        });
        sessionStorage.GRUPOS_USUARIO--;
        
        return false;
      };
    } else {
      btn_participar.innerHTML = "Inscrever";
      btn_participar.onclick = function participar() {
        fetch("/user/participar", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            idUsuarioServer: sessionStorage.ID_USUARIO,
            idGrupoServer: sessionStorage.IDGRUPO,
          }),
        })
        .then(function (resposta) {
          console.log("ESTOU NO THEN DO entrar()!");
          
          if (resposta.ok) {
            resposta.json().then(function (resposta) {
              console.log("Dados recebidos: ", JSON.stringify(resposta));
              
              alert("Bem-vindo ao grupo: " + local);
              window.location.reload(true);
              sessionStorage.participa4 = 1;
            });
          } else {
            alert("Houve um erro ao tentar realizar o login!");
            console.log("Houve um erro ao tentar realizar o login!");
          }
        })
        .catch(function (erro) {
          console.log(erro);
        });
        sessionStorage.GRUPOS_USUARIO++;
  
        return false;
      };
    }
  } else if (local == "TOC") {
    sessionStorage.IDGRUPO = 5;
    if (participa5 == 1) {
      btn_participar.innerHTML = "Desinscrever";
      btn_participar.onclick = function deletar() {
        fetch("/user/remover", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            idUsuarioServer: sessionStorage.ID_USUARIO,
            idGrupoServer: sessionStorage.IDGRUPO,
          }),
        })
        .then(function (resposta) {
          console.log("ESTOU NO THEN DO entrar()!");
          
          if (resposta.ok) {
            resposta.json().then(function (resposta) {
              console.log("Dados recebidos: ", JSON.stringify(resposta));
              
              alert("Você não participa mais do grupo: " + local);
              window.location.reload(true);
              sessionStorage.participa5 = 0;
            });
          } else {
            alert("Houve um erro ao tentar realizar o login!");
            console.log("Houve um erro ao tentar realizar o login!");
          }
        })
        .catch(function (erro) {
          console.log(erro);
        });
        sessionStorage.GRUPOS_USUARIO--;
        
        return false;
      };
    } else {
      btn_participar.innerHTML = "Inscrever";
      btn_participar.onclick = function participar() {
        fetch("/user/participar", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            idUsuarioServer: sessionStorage.ID_USUARIO,
            idGrupoServer: sessionStorage.IDGRUPO,
          }),
        })
        .then(function (resposta) {
          console.log("ESTOU NO THEN DO entrar()!");
          
          if (resposta.ok) {
            resposta.json().then(function (resposta) {
              console.log("Dados recebidos: ", JSON.stringify(resposta));
              
              alert("Bem-vindo ao grupo: " + local);
              window.location.reload(true);
              sessionStorage.participa5 = 1;
            });
          } else {
            alert("Houve um erro ao tentar realizar o login!");
            console.log("Houve um erro ao tentar realizar o login!");
          }
        })
        .catch(function (erro) {
          console.log(erro);
        });
        sessionStorage.GRUPOS_USUARIO++;
  
        return false;
      };
    }
  } else if (local == "Outros") {
    sessionStorage.IDGRUPO = 6;
    if (participa6 == 1) {
      btn_participar.innerHTML = "Desinscrever";
      btn_participar.onclick = function deletar() {
        fetch("/user/remover", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            idUsuarioServer: sessionStorage.ID_USUARIO,
            idGrupoServer: sessionStorage.IDGRUPO,
          }),
        })
        .then(function (resposta) {
          console.log("ESTOU NO THEN DO entrar()!");
          
          if (resposta.ok) {
            resposta.json().then(function (resposta) {
              console.log("Dados recebidos: ", JSON.stringify(resposta));
              
              alert("Você não participa mais do grupo: " + local);
              window.location.reload(true);
              sessionStorage.participa6 = 0;
            });
          } else {
            alert("Houve um erro ao tentar realizar o login!");
            console.log("Houve um erro ao tentar realizar o login!");
          }
        })
        .catch(function (erro) {
          console.log(erro);
        });
        sessionStorage.GRUPOS_USUARIO--;
        
        return false;
      };
    } else {
      btn_participar.innerHTML = "Inscrever";
      btn_participar.onclick = function participar() {
        fetch("/user/participar", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            idUsuarioServer: sessionStorage.ID_USUARIO,
            idGrupoServer: sessionStorage.IDGRUPO,
          }),
        })
        .then(function (resposta) {
          console.log("ESTOU NO THEN DO entrar()!");
          
          if (resposta.ok) {
            resposta.json().then(function (resposta) {
              console.log("Dados recebidos: ", JSON.stringify(resposta));
              
              alert("Bem-vindo ao grupo: " + local);
              window.location.reload(true);
              sessionStorage.participa6 = 1;
            });
          } else {
            alert("Houve um erro ao tentar realizar o login!");
            console.log("Houve um erro ao tentar realizar o login!");
          }
        })
        .catch(function (erro) {
          console.log(erro);
        });
        sessionStorage.GRUPOS_USUARIO++;
  
        return false;
      };
    }
  }


  function acessar() {
    fetch("/user/acessar", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        idGrupoServer: sessionStorage.IDGRUPO,
      }),
    })
      .then(function (resposta) {
        console.log("ESTOU NO THEN DO entrar()!");

        if (resposta.ok) {
          resposta.json().then(function (resposta) {
            console.log("Dados recebidos: ", JSON.stringify(resposta));

            var feed = document.getElementById("posts");

            console.log(resposta)
            if(resposta == "vazio") {

              console.log(resposta)
              var divPublicacao = document.createElement("div");
              var spanTituloVazio = document.createElement("span"); 

              spanTituloVazio.innerHTML = "Nada por aqui " + sessionStorage.NOME_USUARIO + "... <br> Seja o primeiro a comentar algo";
              
              divPublicacao.appendChild(spanTituloVazio);
              divPublicacao.className = "divPublicacao";
              feed.appendChild(divPublicacao);

            } else {
            for (var i = resposta.resposta.length - 1; i >= 0; i--) {

              var publicacao = resposta.resposta[i];

              var divPublicacao = document.createElement("div");
              var spanTitulo = document.createElement("span");
              var spanId = document.createElement("span");
              var spanData = document.createElement("span");
              var spanGrupo = document.createElement("span");
              var data = new Date(publicacao.dtPost);
              var dataFormat = data.toLocaleString("pt-BR");

              spanTituloVazio += 
              "";
              spanTitulo.innerHTML +=
                "Publicação: <b>'" + publicacao.texto + "'</b>";
              spanId.innerHTML +=
                "Id da Postagem: " + publicacao.idPostagem + ".";
              spanData.innerHTML += "Data de postagem: " + dataFormat + ".";
              spanGrupo.innerHTML +=
                "Feita por: " + publicacao.nome;

              divPublicacao.className = "divPublicacao";
              spanId.className = "subdescricao";
              spanGrupo.className = "subdescricao";
              spanData.className = "descricao";

              divPublicacao.appendChild(spanId);
              divPublicacao.appendChild(spanGrupo);
              divPublicacao.appendChild(spanTitulo);
              divPublicacao.appendChild(spanData);
              feed.appendChild(divPublicacao);

            }}
          });
        } else {
          console.log("Houve um erro ao tentar realizar o login!");
        }
      })
      .catch(function (erro) {
        console.log(erro);
      });

    return false;
  }

  function sair() {
    mensagem_sair.style.display = "Flex";
  }

  function fechar() {
    mensagem_sair.style.display = "None";
  }

  function home() {
    window.location.href = "index.html";
  }

  function postar() {
    var postVar = inp_post.value;
    var idUsuarioVar = sessionStorage.ID_USUARIO;

    fetch("/user/postar", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        postServer: postVar,
        idUsuarioServer: idUsuarioVar,
        idGrupoServer: sessionStorage.IDGRUPO,
      }),
    }).then(function (resposta) {
      console.log("RESPOSTA: ", resposta);

      if (resposta.ok) {
        alert("Post realizado com sucesso");
        window.location.reload(true);
      } else {
        throw "Houve um erro ao tentar realizar o cadastro!";
      }
    });
  }
</script>

</html>